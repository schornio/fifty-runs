generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL_NON_POOLING")
}

model Group {
  id            String           @id @default(uuid())
  name          String           @unique
  nameId        String           @unique
  
  // Relation zu den Mitgliedern
  users         User[]           @relation("GroupMembers")

  // Ersteller der Gruppe
  createdById   String
  createdBy     User             @relation("GroupCreator", fields: [createdById], references: [id], onDelete: Cascade)

  // Aktueller Admin der Gruppe
  adminId       String?          
  admin         User?            @relation("GroupAdmin", fields: [adminId], references: [id], onDelete: SetNull)

  // Einladungen & Beitrittsanfragen
  invitations   GroupInvitation[]
  requests      GroupRequest[]

  // Statistiken
  totalDistance Int              @default(0)
  totalDuration Int              @default(0)
}

model GroupInvitation {
  id        String  @id @default(uuid())
  groupId   String
  group     Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  token     String  @unique
  createdAt DateTime @default(now())
  usedAt    DateTime?
}

model GroupRequest {
  id        String  @id @default(uuid())
  groupId   String
  userId    String

  // Relation zur Gruppe
  group     Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Relation zum Benutzer (Fix!)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

model User {
  id                            String              @id @default(uuid())
  name                          String              @unique
  nameId                        String              @unique
  email                         String              @unique
  emailVerified                 Boolean             @default(false)
  emailVerificationToken        String?
  password                      String
  passwordResetToken            String?
  passwordResetTokenExpiry      DateTime?
  image                         String?
  runDonationMultiplier         DonationMultiplier?
  runDonationMultiplierAskAgain DateTime?
  groupId                       String?
  createdAt                     DateTime?           @default(now())
  garminAccessToken             String?
  garminAccessTokenSecret       String?
  comments                      Comment[]
  GarminAuth                    GarminAuth?
  postings                      Posting[]
  reactions                     Reaction[]
  readNotifications             ReadNotification[]
  runningStatistic              RunningStatistic?
  sessions                      Session[]

  // Relation zur Gruppe (Fix!)
  group                         Group?  @relation("GroupMembers", fields: [groupId], references: [id])

  // Gruppen, die der User erstellt hat
  createdGroups                 Group[] @relation("GroupCreator")

  // Gruppen, bei denen der User Admin ist
  adminGroups                   Group[] @relation("GroupAdmin")

  // Alle Beitrittsanfragen des Users
  requests                      GroupRequest[]

  @@unique([nameId, email])
  @@index([emailVerificationToken])
  @@index([runDonationMultiplierAskAgain, runDonationMultiplier])
}


model GarminAuth {
  oauthToken       String @id
  oauthTokenSecret String
  userId           String @unique
  user             User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])
}

model Posting {
  id                String           @id @default(uuid())
  date              DateTime
  text              String?
  image             String?
  userId            String
  visibility        Visibility       @default(protected)
  runningExerciseId String?
  season            String
  comments          Comment[]
  donation          Donation?
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactions         Reaction[]
  runningExercise   RunningExercise?
}

model Comment {
  id        String   @id @default(uuid())
  text      String
  date      DateTime @default(now())
  userId    String
  postingId String
  posting   Posting  @relation(fields: [postingId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Reaction {
  id        String   @id @default(uuid())
  type      String
  date      DateTime @default(now())
  userId    String
  postingId String?
  Posting   Posting? @relation(fields: [postingId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postingId])
}

model Donation {
  id           String   @id @default(uuid())
  amountInCent Int
  date         DateTime @default(now())
  postingId    String   @unique
  posting      Posting  @relation(fields: [postingId], references: [id], onDelete: Cascade)
}

model RunningExercise {
  id                String  @id @default(uuid())
  distanceInMeters  Int
  durationInSeconds Int
  postingId         String  @unique
  garminActivityId  String? @unique
  posting           Posting @relation(fields: [postingId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now())
}

model RunningStatistic {
  id                String @id @default(uuid())
  numberOfRuns      Int
  distanceInMeters  Int
  durationInSeconds Int
  userId            String @unique
  season            String
  user              User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ReadNotification {
  id             String   @id @default(uuid())
  userId         String
  notificationId String
  readAt         DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationId])
}

enum Visibility {
  public
  protected
  private
}

enum DonationMultiplier {
  x1
  x2
  x5
  x10
}
